From d0724b07260c350d60030d831c65f53338be5d57 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Nicolas=20Vi=C3=A9ville?= <nicolas.vieville@uphf.fr>
Date: Thu, 18 Sep 2025 17:03:35 +0200
Subject: [PATCH] =?UTF-8?q?Linux=206.17:=20nvidia-drm-drv.c,=20nvidia-drm-?=
 =?UTF-8?q?fb.c=20and=20nvidia-drm-fb.h,=20related=20to=20commit=20"drm:?=
 =?UTF-8?q?=20Allow=20the=20caller=20to=20pass=20in=20the=20format=20info?=
 =?UTF-8?q?=20to=20drm=5Fhelper=5Fmode=5Ffill=5Ffb=5Fstruct()"=20(Ville=20?=
 =?UTF-8?q?Syrj=C3=A4l=C3=A4,=201=20Jul=202025)?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Nicolas Viéville <nicolas.vieville@uphf.fr>
---
 kernel/nvidia-drm/nvidia-drm-drv.c | 14 ++++++++++++++
 kernel/nvidia-drm/nvidia-drm-fb.c  | 29 +++++++++++++++++++++++++++++
 kernel/nvidia-drm/nvidia-drm-fb.h  | 16 ++++++++++++++++
 3 files changed, 59 insertions(+)

diff --git a/kernel/nvidia-drm/nvidia-drm-drv.c b/kernel/nvidia-drm/nvidia-drm-drv.c
index 92ef959..cd0bcac 100644
--- a/kernel/nvidia-drm/nvidia-drm-drv.c
+++ b/kernel/nvidia-drm/nvidia-drm-drv.c
@@ -163,6 +163,20 @@ static struct drm_framebuffer *nv_drm_framebuffer_create(
     fb = nv_drm_internal_framebuffer_create(
             dev,
             file,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+            // Added by commit a34cc7bf1034280904f9683e260f9d9e9fd4b84f
+            // "drm: Allow the caller to pass in the format info to
+            // drm_helper_mode_fill_fb_struct()" in kernel 6.17 - Ville Syrjälä,
+            // 1 Jul 2025.
+            // Soon all drivers should have the format info already available
+            // in the places where they call drm_helper_mode_fill_fb_struct().
+            // Allow it to be passed along into drm_helper_mode_fill_fb_struct()
+            // instead of doing yet another redundant lookup.
+            //
+            // Start by always passing in NULL and still doing the extra lookup.
+            // The actual changes to avoid the lookup will follow.
+            info,
+#endif
             &local_cmd);
 
     #if !defined(NV_DRM_HELPER_MODE_FILL_FB_STRUCT_HAS_CONST_MODE_CMD_ARG)
diff --git a/kernel/nvidia-drm/nvidia-drm-fb.c b/kernel/nvidia-drm/nvidia-drm-fb.c
index e0b94f2..a982c9a 100644
--- a/kernel/nvidia-drm/nvidia-drm-fb.c
+++ b/kernel/nvidia-drm/nvidia-drm-fb.c
@@ -32,6 +32,7 @@
 
 #include <drm/drm_crtc_helper.h>
 #include <drm/drm_modeset_helper.h>
+#include <linux/version.h>
 
 static void nv_drm_framebuffer_destroy(struct drm_framebuffer *fb)
 {
@@ -157,6 +158,20 @@ static int nv_drm_framebuffer_init(
 struct drm_framebuffer *nv_drm_internal_framebuffer_create(
     struct drm_device *dev,
     struct drm_file *file,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+    // Added by commit a34cc7bf1034280904f9683e260f9d9e9fd4b84f
+    // "drm: Allow the caller to pass in the format info to
+    // drm_helper_mode_fill_fb_struct()" in kernel 6.17 - Ville Syrjälä,
+    // 1 Jul 2025.
+    // Soon all drivers should have the format info already available
+    // in the places where they call drm_helper_mode_fill_fb_struct().
+    // Allow it to be passed along into drm_helper_mode_fill_fb_struct()
+    // instead of doing yet another redundant lookup.
+    //
+    // Start by always passing in NULL and still doing the extra lookup.
+    // The actual changes to avoid the lookup will follow.
+    const struct drm_format_info *info,
+#endif
     struct drm_mode_fb_cmd2 *cmd)
 {
     struct nv_drm_framebuffer *nv_fb;
@@ -183,6 +198,20 @@ struct drm_framebuffer *nv_drm_internal_framebuffer_create(
         dev,
         #endif
         &nv_fb->base,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+        // Added by commit a34cc7bf1034280904f9683e260f9d9e9fd4b84f
+        // "drm: Allow the caller to pass in the format info to
+        // drm_helper_mode_fill_fb_struct()" in kernel 6.17 - Ville Syrjälä,
+        // 1 Jul 2025.
+        // Soon all drivers should have the format info already available
+        // in the places where they call drm_helper_mode_fill_fb_struct().
+        // Allow it to be passed along into drm_helper_mode_fill_fb_struct()
+        // instead of doing yet another redundant lookup.
+        //
+        // Start by always passing in NULL and still doing the extra lookup.
+        // The actual changes to avoid the lookup will follow.
+        info,
+#endif
         cmd);
 
     /*
diff --git a/kernel/nvidia-drm/nvidia-drm-fb.h b/kernel/nvidia-drm/nvidia-drm-fb.h
index bfa93fd..51ad62d 100644
--- a/kernel/nvidia-drm/nvidia-drm-fb.h
+++ b/kernel/nvidia-drm/nvidia-drm-fb.h
@@ -35,6 +35,8 @@
 #include <drm/drm_framebuffer.h>
 #endif
 
+#include <linux/version.h>
+
 #include "nvidia-drm-gem-nvkms-memory.h"
 #include "nvkms-kapi.h"
 
@@ -58,6 +60,20 @@ static inline struct nv_drm_framebuffer *to_nv_framebuffer(
 struct drm_framebuffer *nv_drm_internal_framebuffer_create(
     struct drm_device *dev,
     struct drm_file *file,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+    // Added by commit a34cc7bf1034280904f9683e260f9d9e9fd4b84f
+    // "drm: Allow the caller to pass in the format info to
+    // drm_helper_mode_fill_fb_struct()" in kernel 6.17 - Ville Syrjälä,
+    // 1 Jul 2025.
+    // Soon all drivers should have the format info already available
+    // in the places where they call drm_helper_mode_fill_fb_struct().
+    // Allow it to be passed along into drm_helper_mode_fill_fb_struct()
+    // instead of doing yet another redundant lookup.
+    //
+    // Start by always passing in NULL and still doing the extra lookup.
+    // The actual changes to avoid the lookup will follow.
+    const struct drm_format_info *info,
+#endif
     struct drm_mode_fb_cmd2 *cmd);
 
 #endif /* NV_DRM_ATOMIC_MODESET_AVAILABLE */
-- 
2.51.0

